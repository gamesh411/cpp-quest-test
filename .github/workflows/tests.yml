name: C++ Quest Tests

on:
  pull_request:
    branches: [ main, first-prototype ]
  push:
    branches: [ main, first-prototype ]

jobs:
  format-check:
    name: Check Code Formatting
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install clang-format
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format
    
    - name: Check formatting
      run: |
        # Find all C++ files in sessions directory
        FILES=$(find sessions -name "*.cpp" -o -name "*.h" 2>/dev/null || true)
        
        if [ -z "$FILES" ]; then
          echo "â„¹ï¸  No C++ files found to check"
          exit 0
        fi
        
        echo "ğŸ“ Checking formatting for:"
        echo "$FILES"
        echo ""
        
        # Check each file
        FAILED=0
        for FILE in $FILES; do
          # Skip .solution directories (instructor only)
          if [[ "$FILE" == *".solution"* ]]; then
            continue
          fi
          
          # Skip test files (they have their own style)
          if [[ "$FILE" == *"/tests/"* ]]; then
            continue
          fi
          
          # Check if file needs formatting
          if ! clang-format --dry-run --Werror "$FILE" 2>/dev/null; then
            echo "âŒ $FILE needs formatting"
            echo ""
            echo "Diff for $FILE:"
            clang-format "$FILE" | diff "$FILE" - || true
            echo ""
            FAILED=1
          else
            echo "âœ… $FILE"
          fi
        done
        
        if [ $FAILED -eq 1 ]; then
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ CODE FORMATTING CHECK FAILED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Your code is not properly formatted."
          echo ""
          echo "To fix this, run:"
          echo "  clang-format -i sessions/*/starter/*.cpp sessions/*/starter/*.h"
          echo ""
          echo "Or see docs/formatting.md for IDE integration."
          echo ""
          echo "Then commit and push the changes."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          exit 1
        fi
        
        echo ""
        echo "âœ… All files are properly formatted!"

  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    needs: format-check  # Only run if formatting passes
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++ ninja-build
        
        # Install Catch2 v3 from source (Ubuntu repos have old version)
        git clone --branch v3.7.1 --depth 1 https://github.com/catchorg/Catch2.git
        cd Catch2
        cmake -B build -S . -DBUILD_TESTING=OFF -DCMAKE_BUILD_TYPE=Release
        sudo cmake --build build --target install
        cd ..
        rm -rf Catch2
    
    - name: Configure CMake
      run: |
        cmake -B build -S . \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_CXX_FLAGS="-Wall -Wextra -Werror" \
          -G Ninja
    
    - name: Build all targets
      run: |
        cmake --build build 2>&1 | tee build.log
    
    - name: Check for warnings
      run: |
        if grep -E "warning:|error:" build.log; then
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âš ï¸  COMPILER WARNINGS/ERRORS DETECTED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Build must be clean with -Wall -Wextra -Werror"
          echo ""
          grep -E "warning:|error:" build.log || true
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          exit 1
        fi
        echo "âœ… No warnings - clean build!"
    
    - name: Run all tests
      run: |
        cd build
        ctest --output-on-failure --verbose
    
    - name: Test summary
      if: always()
      run: |
        cd build
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“Š TEST SUMMARY"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        ctest --output-on-failure || true
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  sanitizers:
    name: Sanitizers (ASan + UBSan)
    runs-on: ubuntu-latest
    needs: format-check
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++ ninja-build
        
        # Install Catch2 v3
        git clone --branch v3.7.1 --depth 1 https://github.com/catchorg/Catch2.git
        cd Catch2
        cmake -B build -S . -DBUILD_TESTING=OFF -DCMAKE_BUILD_TYPE=Release
        sudo cmake --build build --target install
        cd ..
        rm -rf Catch2
    
    - name: Configure with sanitizers
      run: |
        cmake -B build -S . \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_CXX_FLAGS="-Wall -Wextra -Werror -fsanitize=address,undefined -fno-omit-frame-pointer -g" \
          -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=address,undefined" \
          -G Ninja
    
    - name: Build with sanitizers
      run: |
        cmake --build build
    
    - name: Run tests with sanitizers
      env:
        ASAN_OPTIONS: detect_leaks=1:check_initialization_order=1:strict_init_order=1
        UBSAN_OPTIONS: print_stacktrace=1:halt_on_error=1
      run: |
        cd build
        echo "ğŸ” Running tests with AddressSanitizer and UndefinedBehaviorSanitizer"
        echo ""
        ctest --output-on-failure --verbose
        echo ""
        echo "âœ… No memory leaks or undefined behavior detected!"
